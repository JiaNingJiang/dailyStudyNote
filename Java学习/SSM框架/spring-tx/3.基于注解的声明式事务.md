# 一、基本程序搭建

1. 依赖

![image-20240607103902137](3.基于注解的声明式事务.assets/image-20240607103902137.png)

2. 配置类

<img src="3.基于注解的声明式事务.assets/image-20240607103953338.png" alt="image-20240607103953338" style="zoom:50%;" />

<img src="3.基于注解的声明式事务.assets/image-20240607104010646.png" alt="image-20240607104010646" style="zoom:50%;" />

3. `DAO` 层

<img src="3.基于注解的声明式事务.assets/image-20240607104050169.png" alt="image-20240607104050169" style="zoom:67%;" />

4. 业务层

<img src="3.基于注解的声明式事务.assets/image-20240607104111518.png" alt="image-20240607104111518" style="zoom:67%;" />

业务层的 `changeInfo` 方法同时操作两条 `SQL` 语句

# 二、事务注解的添加

1. 在**配置类**中选择一个**具体的事务管理器实现类**放入到 `ioc` 容器

![image-20240607104306237](3.基于注解的声明式事务.assets/image-20240607104306237.png)

2. 在配置类中开启事务类注解支持

![image-20240607104350764](3.基于注解的声明式事务.assets/image-20240607104350764.png)

3. 在目标方法上添加事务注解，开启事务

<img src="3.基于注解的声明式事务.assets/image-20240607104452638.png" alt="image-20240607104452638" style="zoom:67%;" />

如上所示，`1/0` 会出错，因此整个事务会回滚。

# 三、高级设置

## 3.1 只读模式设置

![image-20240607110220413](3.基于注解的声明式事务.assets/image-20240607110220413.png)

<img src="3.基于注解的声明式事务.assets/image-20240607110350668.png" alt="image-20240607110350668" style="zoom: 67%;" />

<img src="3.基于注解的声明式事务.assets/image-20240607110404918.png" alt="image-20240607110404918" style="zoom:67%;" />





## 3.2 事务超时时间设置

![image-20240607110425422](3.基于注解的声明式事务.assets/image-20240607110425422.png)

<img src="3.基于注解的声明式事务.assets/image-20240607110445086.png" alt="image-20240607110445086" style="zoom:67%;" />

## 3.3 事务异常指定问题

**默认情况**下，当方法内部发生 **运行时异常** 时，事务才算失败，然后回滚（对于 IO 异常和不会出现回滚）

<img src="3.基于注解的声明式事务.assets/image-20240607110647642.png" alt="image-20240607110647642" style="zoom:67%;" />

默认情况下，下述方法的事务不会发生回滚（因为发生的是 IO 异常）：

![image-20240607110729028](3.基于注解的声明式事务.assets/image-20240607110729028.png)

经过异常范围扩大后，就会发生回滚：

<img src="3.基于注解的声明式事务.assets/image-20240607110834388.png" alt="image-20240607110834388" style="zoom:67%;" />

`noRollbackFor` 的作用：回滚异常范围内，控制某个异常不回滚：

![image-20240607110935196](3.基于注解的声明式事务.assets/image-20240607110935196.png)

## 3.4 事务隔离级别

![image-20240607111002629](3.基于注解的声明式事务.assets/image-20240607111002629.png)

![image-20240607111036583](3.基于注解的声明式事务.assets/image-20240607111036583.png)

## 3.5 事务传播行为

1. 场景

<img src="3.基于注解的声明式事务.assets/image-20240607111108585.png" alt="image-20240607111108585" style="zoom: 50%;" />

<img src="3.基于注解的声明式事务.assets/image-20240607111134507.png" alt="image-20240607111134507" style="zoom:67%;" />

2. 举例说明

<img src="3.基于注解的声明式事务.assets/image-20240607111246308.png" alt="image-20240607111246308" style="zoom:67%;" />

![image-20240607111309879](3.基于注解的声明式事务.assets/image-20240607111309879.png)

3. `propagation` 属性

![image-20240607111353109](3.基于注解的声明式事务.assets/image-20240607111353109.png)

<img src="3.基于注解的声明式事务.assets/image-20240607111427713.png" alt="image-20240607111427713" style="zoom:67%;" />

![image-20240607111454042](3.基于注解的声明式事务.assets/image-20240607111454042.png)

4. 注意

![image-20240607111529271](3.基于注解的声明式事务.assets/image-20240607111529271.png)

父方法与子方法要位于**不同的类**中才可以实现事务传播行为。

5. 其他传播行为值

![image-20240607111728941](3.基于注解的声明式事务.assets/image-20240607111728941.png)