## 一、`sed`指令介绍

我们知道，Vim 采用的是交互式文本编辑模式，你可以用键盘命令来交互性地插入、删除或替换数据中的文本。但本节要讲的 sed 命令不同，它采用的是**流编辑模式**，最明显的特点是，**在 sed 处理数据之前，需要预先提供一组规则，sed 会按照此规则来编辑数据**。

sed 会根据脚本命令来处理文本文件中的数据，这些命令要么从命令行中输入，要么存储在一个文本文件中，此命令执行数据的顺序如下：

1. **每次仅读取待处理文本文件的一行内容**；
2. 根据提供的规则命令匹配并修改数据。注意，**sed 默认不会直接修改源文件数据，而是会将数据复制到缓冲区中，修改也仅限于缓冲区中的数据**；
3. 将**执行结果输出**。

**当一行数据匹配完成后，它会继续读取下一行数据**，并重复这个过程，**直到将文件中所有数据处理完毕**。

sed 命令的基本格式如下：

```shell
[root@localhost ~]# sed [选项] [脚本命令] 文件名
```

该命令**常用的选项**及含义，如表 1 所示。

| 选项            | 含义                                                         |
| --------------- | ------------------------------------------------------------ |
| -e 脚本命令     | 该选项会将其后跟的脚本命令添加到已有的命令中。               |
| -f 脚本命令文件 | 该选项会将其后文件中的脚本命令添加到已有的命令中。           |
| -n              | 默认情况下，sed 会在所有的脚本指定执行完毕后，会自动输出处理后的内容，而**该选项会屏蔽启动输出，需使用 print 命令来完成输出。** |
| -i              | **此选项会直接修改源文件**，要慎用。                         |

## 二、各种`sed`脚本命令

### 2.1 `sed s` 替换脚本命令

此命令的基本格式为：

```shell
[address]s/pattern/replacement/flags
```

其中，**address 表示指定要操作的具体行**，**pattern 指的是需要替换的内容**，**replacement 指的是要替换的新内容**。

> 关于指定具体操作行（address）的用法，这里先不做解释，文章后续会对其做详细介绍。

此命令中常用的 flags 标记如表 2 所示。

| flags 标记 | 功能                                                         |
| ---------- | ------------------------------------------------------------ |
| n          | **1~512 之间的数字**，表示指定**要替换的字符串出现第几次时才进行替换**，例如，一行中**有 3 个 A**，但用户**只想替换第二个 A**，这是就用到这个标记； |
| g          | 对数据中**所有匹配到的内容进行替换**，如果**没有 g标记，则默认只会在第一次匹配成功时做替换操作**。例如，一行数据中有 3 个 A，则只会替换第一个 A； |
| p          | 会**打印与替换命令中指定的模式匹配的行**。此标记通常**与 -n 选项一起使用**。 |
| w file     | 将**缓冲区中的内容写到指定的 file 文件中**；                 |
| &          | 用正则表达式匹配的内容进行替换；                             |
| \n         | 匹配第 n 个子串，该子串之前在 pattern 中用 \(\) 指定。       |
| \          | **转义（转义替换部分包含：&、\ 等）**。                      |

【例1】比如，可以指定` sed `用新文本替换第2处模式匹配的地方：

```shell
[root@localhost ~]# sed 's/test/trial/2' data4.txt   # 将每行第二处的test替换为trial
This is a test of the trial script.
This is the second test of the trial script.
```

可以看到，使用**数字 2 作为标记**的结果就是，**sed 编辑器只替换每行中第 2 次出现的匹配模式**。

【例2】如果要用新文件**替换所有匹配的字符串**，可以使用 **g 标记**：

```shell
[root@localhost ~]# sed 's/test/trial/g' data4.txt
This is a trial of the trial script.
This is the second trial of the trial script.
```

【例3】只输出被替换命令修改过的行

我们知道，**-n 选项会禁止 sed 输出**，但 **p 标记会输出修改过的行**，将二者**匹配使用**的效果就是**只输出被替换命令修改过的行**，例如：

```shell
[root@localhost ~]# cat data5.txt
This is a test line.
This is a different line.
[root@localhost ~]# sed -n 's/test/trial/p' data5.txt
This is a trial line.
```

【例4】将完成匹配的结果保存到指定文件

**w 标记**会**将完成匹配的结果保存到指定文件**中，比如：

```shell
[root@localhost ~]# sed 's/test/trial/w test.txt' data5.txt
This is a trial line.
This is a different line.
[root@localhost ~]#cat test.txt
This is a trial line.
```

【例5】替换类似文件路径的字符串

在使用 s 脚本命令时，**替换类似文件路径的字符串**会比较麻烦，**需要将路径中的正斜线进行转义**，例如：

```shell
[root@localhost ~]# sed 's/\/bin\/bash/\/bin\/csh/' /etc/passwd
```

### 2.2 `sed d` 替换脚本命令

此命令的基本格式为：

```shell
[address]d
```

如果需要**删除文本中的特定行**，可以用 **d 脚本命令**，它会**删除指定行中的所有内容**。但使用该命令时要特别小心，如果你**忘记指定具体行的话，文件中的所有内容都会被删除**，举个例子：

```shell
[root@localhost ~]# cat data1.txt
The quick brown fox jumps over the lazy dog
The quick brown fox jumps over the lazy dog
The quick brown fox jumps over the lazy dog
The quick brown fox jumps over the lazy dog
[root@localhost ~]# sed 'd' data1.txt
#什么也不输出，证明成了空文件
```

当和指定地址一起使用时，删除命令显然能发挥出大的功用。可以从数据流中删除特定的文本行。

address 的具体写法后续会做详细介绍，这里只给大家举几个简单的例子：

1. **通过行号指定**，比如**删除** data6.txt 文件内容中的**第 3 行**：

```shell
[root@localhost ~]# cat data6.txt
This is line number 1.
This is line number 2.
This is line number 3.
This is line number 4.
[root@localhost ~]# sed '3d' data6.txt
This is line number 1.
This is line number 2.
This is line number 4.
```

2. 或者**通过特定行区间指定**，比如**删除** data6.txt 文件内容中的**第 2、3行**：

```shell
[root@localhost ~]# sed '2,3d' data6.txt
This is line number 1.
This is line number 4.
```

3. 也可以使用**两个文本模式**来**删除某个区间内的行**，但这么做时要小心，你指定的第一个模式会“打开”行删除功能，第二个模式会“关闭”行删除功能，因此，**sed 会删除两个指定行之间的所有行（包括指定的行）**，例如：

```shell
[root@localhost ~]#sed '/1/,/3/d' data6.txt
#删除第 1~3 行的文本数据
This is line number 4.
```

4. 或者通过**特殊的文件结尾字符**，比如**删除** data6.txt 文件内容中**第 3 行开始往下的所有内容**：

```shell
[root@localhost ~]# sed '3,$d' data6.txt
This is line number 1.
This is line number 2.
```

