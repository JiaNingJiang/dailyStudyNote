## 一、CAP定理的概念

CAP 定理指的是在一个分布式系统中，**一致性 Consistency**、**可用性 Availability**、**分区容错性 Partition tolerance**，三者不可兼得。

- 一致性（C）：分布式系统中多个主机之间是否能够保持数据一致的特性。即，当**系统数据发生更新操作后，各个主机中的数据仍然处于一致的状态**。
- 可用性（A）：系统提供的服务必须一直处于可用的状态，即对于用户的每一个请求，系统总是可以**在有限的时间内对用户做出响应**。
- 分区容错性（P）：分布式系统在**遇到任何网络分区故障**时，仍能够保证对外提供满足一致性和可用性的服务。

## 二、CAP定理内容

​	CAP 定理的内容是：对于分布式系统，网络环境相对是不可控的，出现网络分区是不可避免的，因此系统**必须具备分区容错性**。但系统**不能同时保证一致性与可用性**。即要么 CP，要么 AP。

## 三、BASE 理论

​	BASE 是 **Basically Available（基本可用）**、**Soft state（软状态）**和 **Eventually consistent（最终一致性）**三个短语的简写，**BASE 是对 CAP 中一致性和可用性权衡的结果**，其来源于对大规模互联网系统分布式实践的结论，是基于 CAP 定理逐步演化而来的。

​	BASE 理论的核心思想是：**即使无法做到强一致性**，但每个系统都可以根据自身的业务特点，**采用适当的方式来使系统达到最终一致性**。

### 3.1 基本可用

​	基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性。损失部分可用性可以是：

- 时间上的可用性，允许在一段有限时间可以不提供服务
- 服务上的可用性，允许停止部分服务
- 用户数量上的可用性，允许只对部分用户而言服务是可用的，而其他用户不可用

### 3.2  软状态

​	软状态，是指**允许系统数据存在的中间状态**，并认为该中间状态的存在不会影响系统的整体可用性，即**允许系统主机间进行数据同步的过程存在一定延时**。软状态，其实就是一种灰度状态，过渡状态。

### 3.3  最终一致性

​	最终一致性强调的是系统中所有的数据副本，在**经过一段时间的同步后，最终能够达到一个一致的状态**。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而**不需要保证系统数据的实时一致性**。



对于各种"一致性"，介绍如下：

1. 如果从**时间角度**上分类：

- **实时一致性**：要求数据内容一旦发生更新，客户端可以立即访问到最新的数据。所以，在集群环境下该特性是无法实现的，只存在于单机环境中。
- **最终一致性**：数据内容发生更新后，经过一小段时间后，客户端可以访问到最新的数据。

2. 如果从**内容角度**上分类：

- **强一致性**：也称为严格一致性。要求客户端访问到的**一定是更新过的新数据**。
- **弱一致性**：允许在**有限时间内**客户端从集群的不同节点访问到的**数据是不一致的**。

## 四、CAP的应用

​	下面将生产中常见到的一些中间件与服务器集群的 CAP 特性进行分析。

### 4.1  Zookeeper 与 CAP

​	Zookeeper 遵循的是 CP 模式，即保证了一致性，但牺牲了可用性。

​	当 Leader 节点中的数据发生了变化后，在 Follower 还**没有同步完成之前，整个 Zookeeper集群是不对外提供服务的**。如果此时有客户端来访问数据，则客户端会因访问超时而发生重试。不过，**由于 Leader 的选举非常快，所以这种重试对于用户来说几乎是感知不到的**。所以说，Zookeeper 保证了一致性，但牺牲了可用性。

### 4.2 Consul 与 CAP

​	Consul 遵循的是 CP 模式，即保证了一致性，但牺牲了可用性。

### 4.3 Redis 与 CAP

​	Redis 遵循的是 AP 模式，即保证了可用性，但牺牲了一致性。

### 4.4  Eureka 与 CAP

​	Eureka 遵循的是 AP 模式，即保证了可用性，但牺牲了一致性。

### 4.5  Nacos 与 CAP

​	Nacos 在做注册中心时，默认是 AP 的。但其也支持 CP 模式，但需要用户提交请求进行转换